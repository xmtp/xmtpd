name: Lint
on:
  push:
    branches:
      - main
  pull_request:
    paths:
      - ".github/workflows/lint-go.yml"
      - "pkg/**"
      - "cmd/**"
      - "dev/**"
      - "go.mod"
      - "go.sum"
      - "tools.go"
      - ".golangci.yaml"
permissions:
  contents: read
jobs:
  lint-go:
    name: Lint-Go
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-go@v3
        with:
          go-version-file: go.mod
      - name: golangci-lint
        uses: golangci/golangci-lint-action@v3
        with:
          args: --timeout=5m --config .golangci.yaml
      - run: go install github.com/segmentio/golines
      - name: golines
        uses: nickcharlton/diff-check@main
        with:
          command: dev/lint-golines
      - run: | 
          go install github.com/sqlc-dev/sqlc/cmd/sqlc
          go install github.com/vektra/mockery/v2
      - run: |
          sqlc generate
          go generate ./...
          mockery

      - name: Check for changes
        working-directory: ${{ github.workspace }}
        run: |
          if git diff --exit-code --ignore-space-change --ignore-all-space --ignore-cr-at-eol -- pgk; then
            echo "No changes detected."
          else
            echo "ERROR: Generated files are not up to date. Please run 'dev/generate' and commit the changes."
            exit 1
          fi