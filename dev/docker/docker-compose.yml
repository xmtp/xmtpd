services:
  db:
    image: postgres:16
    environment:
      POSTGRES_PASSWORD: xmtp
    ports:
      - 8765:5432

  db2:
    image: postgres:16
    environment:
      POSTGRES_PASSWORD: xmtp
    ports:
      - 8766:5432

  chain:
    platform: linux/amd64
    image: ghcr.io/xmtp/contracts:sha-cff29fc
    ports:
      - 7545:8545

  validation:
    image: ghcr.io/xmtp/mls-validation-service:main
    platform: linux/amd64
    ports:
      - 60051:50051

  prometheus:
    image: ubuntu/prometheus
    ports:
      - 9090:9090
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml

  grafana:
    image: grafana/grafana
    ports:
      - "3000:3000"
    volumes:
      - grafana_data:/var/lib/grafana
    environment:
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_NAME=Viewer
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Viewer

  register-node-1:
    platform: linux/amd64
    image: ghcr.io/xmtp/xmtpd-cli:main
    profiles: ["single", "dual"]
    environment:
      - XMTPD_CONTRACTS_RPC_URL=http://chain:8545
    env_file:
      - ../local.env
    command:
      [
        "register-node",
        "--http-address=${NODE_1_HTTP_ADDRESS}",
        "--node-owner-address=${ANVIL_ACC_1_ADDRESS}",
        "--node-signing-key-pub=${ANVIL_ACC_1_PUBLIC_KEY}",
        "--admin.private-key=${PRIVATE_KEY}",
      ]
    depends_on:
      chain:
        condition: service_started
    restart: on-failure

  enable-node-1:
    platform: linux/amd64
    image: ghcr.io/xmtp/xmtpd-cli:main
    profiles: ["single", "dual"]
    environment:
      - XMTPD_CONTRACTS_RPC_URL=http://chain:8545
    env_file:
      - ../local.env
    command:
      ["add-node-to-network", "--private-key=${PRIVATE_KEY}", "--node-id=100"]
    depends_on:
      chain:
        condition: service_started
      register-node-1:
        condition: service_completed_successfully
    restart: on-failure

  register-node-2:
    platform: linux/amd64
    image: ghcr.io/xmtp/xmtpd-cli:main
    profiles: ["dual"]
    environment:
      - XMTPD_CONTRACTS_RPC_URL=http://chain:8545
    env_file:
      - ../local.env
    command:
      [
        "register-node",
        "--http-address=${NODE_2_HTTP_ADDRESS}",
        "--node-owner-address=${ANVIL_ACC_2_ADDRESS}",
        "--node-signing-key-pub=${ANVIL_ACC_2_PUBLIC_KEY}",
        "--admin.private-key=${PRIVATE_KEY}",
      ]
    depends_on:
      chain:
        condition: service_started
      enable-node-1:
        condition: service_completed_successfully
    restart: on-failure

  enable-node-2:
    platform: linux/amd64
    image: ghcr.io/xmtp/xmtpd-cli:main
    profiles: ["dual"]
    environment:
      - XMTPD_CONTRACTS_RPC_URL=http://chain:8545
    env_file:
      - ../local.env
    command:
      ["add-node-to-network", "--private-key=${PRIVATE_KEY}", "--node-id=200"]
    depends_on:
      chain:
        condition: service_started
      register-node-2:
        condition: service_completed_successfully
    restart: on-failure

volumes:
  grafana_data:
