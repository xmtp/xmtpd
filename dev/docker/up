#!/bin/bash
set -eo pipefail

if [ -z "$1" ]; then
  profile="single"
  echo "No profile provided, defaulting to single"
elif [ "$1" = "single" ] || [ "$1" = "dual" ]; then
  profile="$1"
else
  echo "Invalid profile '$1', defaulting to single"
  profile="single"
fi

docker compose \
  -f dev/docker/docker-compose.yml \
  --env-file dev/local.env \
  --profile "${profile}" \
  -p "xmtpd" \
  up -d \
  --remove-orphans \
  --wait

# Build CLI image once
docker compose \
  -f dev/docker/docker-compose-register.yml \
  -p "xmtpd_register_nodes" \
  build

# Source env vars for CLI command arguments
. dev/local.env

run_cli() {
  docker compose \
    -f dev/docker/docker-compose-register.yml \
    -p "xmtpd_register_nodes" \
    run --rm cli \
    --config-file=config://anvil \
    --private-key="${PRIVATE_KEY}" \
    "$@"
}

# Register and enable node 1
run_cli \
  nodes register \
  --owner-address="${ANVIL_ACC_1_ADDRESS}" \
  --signing-key-pub="${ANVIL_ACC_1_PUBLIC_KEY}" \
  --http-address="${NODE_1_HTTP_ADDRESS}"

run_cli \
  nodes canonical-network \
  --add \
  --node-id=100

# Register and enable node 2 (dual only)
if [ "${profile}" = "dual" ]; then
  run_cli \
    nodes register \
    --owner-address="${ANVIL_ACC_2_ADDRESS}" \
    --signing-key-pub="${ANVIL_ACC_2_PUBLIC_KEY}" \
    --http-address="${NODE_2_HTTP_ADDRESS}"

  run_cli \
    nodes canonical-network \
    --add \
    --node-id=200
fi

echo
