#!/usr/bin/env bash

# Work always from the root directory
script_dir=$(dirname "$(realpath "$0")")
repo_root=$(realpath "${script_dir}/../../")
cd "${repo_root}"

GEN_PROTO_BRANCH="${GEN_PROTO_BRANCH:-main}"

find pkg/proto -type f \( -name "*.pb.go" -o -name "*.pb.gw.go" -o -name "*.swagger.json" \) -exec rm -f {} +
if ! go tool -modfile=tools/go.mod buf generate "https://github.com/xmtp/proto.git#subdir=proto,branch=${GEN_PROTO_BRANCH}"; then
    echo "Failed to generate protobuf definitions"
    exit 1
fi