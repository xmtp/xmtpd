// Package types defines custom types to override types not automatically generated by sqlc.
package types

import (
	"database/sql/driver"
	"encoding/hex"
	"fmt"
	"time"
)

type GatewayEnvelopeRow struct {
	OriginatorNodeID     int32
	OriginatorSequenceID int64
	Topic                []byte
	PayerID              int32
	GatewayTime          time.Time
	Expiry               int64
	OriginatorEnvelope   []byte
	SpendPicodollars     int64
}

// Value implements driver.Valuer to serialize the struct into PostgreSQL composite type format.
// Escaping rules for composite literals (different from string literals):
//   - Inside quotes: \\ becomes \, "" becomes "
//   - Bytea uses hex format: \xDEADBEEF
func (g GatewayEnvelopeRow) Value() (driver.Value, error) {
	// Format timestamp with fixed 6 decimal places for consistency
	ts := g.GatewayTime.UTC().Format("2006-01-02 15:04:05.000000")

	// Bytea: \\x prefix (double backslash becomes single in composite parsing)
	topic := `\\x` + hex.EncodeToString(g.Topic)
	env := `\\x` + hex.EncodeToString(g.OriginatorEnvelope)

	return fmt.Sprintf(`(%d,%d,"%s",%d,"%s",%d,"%s",%d)`,
		g.OriginatorNodeID,
		g.OriginatorSequenceID,
		topic,
		g.PayerID,
		ts,
		g.Expiry,
		env,
		g.SpendPicodollars,
	), nil
}
